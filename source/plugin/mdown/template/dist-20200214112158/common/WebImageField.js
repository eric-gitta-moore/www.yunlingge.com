define(["require"],function(e){var t=function(e){function t(){n.hide(),c.value=mwt.get_value(r),c.fire("change"),""!=c.value&&jQuery("#"+r+"-clear").show(),c.refresh()}function i(){var e=localStorage.getItem(o);if(e){var i=e.split("||");if(0!=i.length){for(var n='<div class="mwt-pop-words"><a id="'+this.render+'-pop-clrbtn" href="javascript:;">清空</a><ul id="'+this.render+'-wdul">',l=0;l<i.length;++l)n+='<li name="'+c.render+'-wd">'+i[l]+"</li>";n+="</ul></div>",jQuery("#"+s).show().html(n),jQuery("[name="+c.render+"-wd]").click(function(){var e=jQuery(this).html();jQuery("#"+r).val(e),t()}),jQuery("#"+this.render+"-pop-clrbtn").click(function(){c.clearwords(),jQuery("#"+this.render+"-wdul").html("")})}}}this.listeners={};var r,n,l,a,s,o,c=this,d="text",u="输入图片链接",h=!1,m="max-height:100px;";if(e){this.construct(e),e.type&&(d=e.type),e.placeholder&&(u=e.placeholder),e.errmsg&&(l=e.errmsg),e.checkfun&&(a=e.checkfun),e.empty&&(h=e.empty),r=this.render+"txt",s=this.render+"pop",e.popStyle&&(m=e.popStyle),o=this.render+"skey";var p=new mwt.ImageUpload({ajaxapi:ajax.getAjaxUrl("upload&action=image")})}this.create=function(){var e=' style="height:26px;"',a='<div class="mwt-row mwt-row-flex"><div class="mwt-col-wd" style="width:110px;"><img id="img-'+r+'" src="'+dz.picurl+'" style="border:solid 1px #9E9E9E;max-width:100px;max-height:70px;" class="mwt-image-view"></div><div class="mwt-col-fill"><div style="position:relative"><input type="'+d+'" id="'+r+'" class="form-control '+this.cls+'" placeholder="'+u+'" style="'+this.style+';padding:0 20px 0 5px;"><i id="'+r+'-clear" class="fa fa-times-circle" style="display:none;color:#999;font-size:14px;margin-left:-20px;vertical-align:middle;"></i></div><div style="margin-top:10px;"><button id="refreshbtn-'+r+'" class="mwt-btn mwt-btn-default mwt-btn-xs"'+e+'>刷新</button>&nbsp;&nbsp;<button id="upbtn-'+r+'" class="mwt-btn mwt-btn-primary mwt-btn-xs"'+e+'>上传本地图片</button></div></div></div><div id="'+s+'" class="mwt-field-pop" style="'+m+'"></div>';jQuery("#"+this.render).html(a),n=new MWT.Popover({anchor:r,html:l,cls:"mwt-popover-danger"}),mwt.initImageView(),this.setValue(this.value);var o=jQuery("#"+r),h=jQuery("#"+r+"-clear"),v=jQuery("#"+s);o.change(t),o.focus(function(){h.show(),i(),jQuery(document).unbind("click").on("click",function(){var e=document.activeElement.id;e!=r&&(v.hide(),h.hide())}),event.stopPropagation()}),v.click(function(e){e.stopPropagation()}),h.click(function(){o.val("").focus()}),jQuery("#refreshbtn-"+r).unbind("click").on("click",c.refresh),jQuery("#upbtn-"+r).unbind("click").on("click",function(){p.upload(function(e){if(0!=e.errno)mwt.alert(e.errmsg);else{var t=e.data.imgurl;c.setValue(t)}})})},this.setValue=function(e){mwt.set_value(r,e),this.value=e,this.refresh()},this.validate=function(){n.hide();var e=h?mwt.get_value(r):mwt.get_text_value(r);return a&&!a(e)?(n.pop(),jQuery("#"+r).focus(),setTimeout(n.hide,2e3),!1):!0},this.readOnly=function(e){e?jQuery("#"+r).attr("readonly",!0):jQuery("#"+r).removeAttr("readonly")},this.addword=function(e){var t=localStorage.getItem(o),i=t?t.split("||"):[];in_array(e,i)||(i.push(e),localStorage.setItem(o,i.join("||")))},this.clearwords=function(){localStorage.removeItem(o)},this.refresh=function(){var e=mwt.get_value(r);""!=e&&jQuery("#img-"+r).attr("src",e)}};return MWT["extends"](t,MWT.Field),t});